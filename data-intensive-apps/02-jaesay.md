# 2장. 데이터 모델과 질의 언어

# 목표

- 데이터 저장과 질의를 위한 다양한 데이터 모델을 살펴본다.
- 관계형 모델(relational model)과 문서 모델(document model), 그리고 몇가지 그래프 기반 데이터 모델(graph-based data model)을 비교한다.
- 다양한 질의 언어를 살펴보고 사용 사례를 비교한다.

# 데이터 모델

세가지 모델 모두 현재 널리 사용하고 있으며 각 모델은 각자의 영역에서 훌륭하다. 한 모델을 다른 모델로 흉내낼 수 있지만 그 결과는 대부분 엉망이다. 이것이 바로 단일 만능 솔루션이 아닌 각기 목적에 맞는 다양한 시스템을 보유해야 하는 이유이다.

## 관계형 모델

오늘날 가장 잘 알려진 데이터 모델은 1970년 에드가 코드(Edgar Codd)가 제안한 관계형 모델을 기반으로 한 SQL이다. 데이터는 (SQL에서 테이블이라 불리는) 관계(relation)로 구성되고 각 관계는 순서 없는 튜플(tuple)(SQL에서 로우(row)) 모음이다.

- (과거에..) 네트워크 모델(코다실 모델)에 비해 애플리케이션에 새로운 기능을 추가하는 작업이 훨씬 쉽다.
    - query optimizer
- 스카마가 있다.
    - 쓰기 스키마(schema-on-write): 관계형데이터베이스의 전통적인 접근 방식으로 스키마는 명시적이고 데이터베이스는 쓰여진 모든 데이터가 스키마를 따르고 있음을 보장한다.
    - 모든 레코드가 동일한 구조라서 예상 가능하다면 스키마가 문서화와 구조를 강제하기 위한 유용한 메커니즘이다.
- 다대일, 다대다 가능
- 객체 관계형 불일치
- 문서 데이터모델보다 조인, 다대일, 다대다 관계를 더 잘지원한다.
- 읽고 쓰기가 편하다. (책 37페이지 마지막 줄들..)

## 문서모델

데이터를 하나의 큰 트리(계층 모델)로 표현한다.

- 스키마 유연성
    - 읽기 스키마(schema-on-read)이다.
        - 읽기 스키마(schema-on-read): 데이터 구조는 암묵적이고 데이터를 읽을 때만 해석된다.
        - 종종 스키마리스(schemaless)로 불리지만 이는 오해의 소지가 있다. (암묵적인 스키마 O, 강요 X)
    - 데이터 타입을 변경하고자 할때 편하다.
        - 성과 이름을 분리하고 싶을때 마이그래이션 필요 없이 새로운 필드를 가진 문서 작성하고 읽는 애플리케이션 코드를 변경하면 된다.
    - 읽기 스키마 접근 방식은 컬렉션 안의 항목이 어떤 이유로 모두 동일한 구조가 아닐 때(즉 데이터가 여러 다른 유형으로 구성돼 있음) 유리하다.
- 질의를 위한 데이터 지역성
    - 문서는 보통 JSON, XML로 부호화된 단일 연속 문자열이나 (몽고DB의 BSON 같은) JSON 또는 XML의 이진 변형으로 저장된다.
    - 애플리케이션이 자주 전체 문서에 접근해야 할 때 저장소 지역성(storage locality)을 활용하면 성능이점이 있다.
    - 지역성 이점은 한번에 해당 문서의 많은 부분을 필요로 하는 경우에만 적용된다.
        - 작은 부분만 접근해도 전체문서를 적재해야 하기에 큰문서에서는 낭비일 수 있다.
        - 문서를 갱신할 때도 보통 전체 문서를 재작성해야 하지만 부호화된 문서의 크기를 바꾸지 않는 수정은 쉽게 수행할 수 있다.
        - 문서를 아주 작게 유지하면서 문서의 크기가 증가하는 쓰기를 피하라고 권장한다.
    - 지역성을 위해 관련 데이터를 함께 그룹화하는 개념이 문서 모델에만 국한되지는 않는다.
        - 오라클의 다중 테이블 색인 클러스터 테이블(multi-table index cluster table), 빅테이블(Bigtable) 데이터 모델의 칼럼 패밀리 개념 등..
- 문서 데이터베이스는 별도 테이블이 아닌 상위레코드 내에 중첩된 레코드(그림 2-1의 positions, education, contact_info 같은 일대다 관계)를 저장한다.
    - 중첩 항목을 바로 참조할 수 없다.
        - 사용자 251의 직위 목록의 두번째 항목"과 같이 표현해야 한다.
        - 하지만 문서가 너무 깊게 중첩되지 않으면 일반적으로 문제가 되지 않는다.
        - 다대다 관계를 사용하면 문서 모델의 매력은 떨어진다.
- 다대일과 다대다 관계를 표현할 때 관계형 데이터베이스와 문서베이스는 근본적으로 다르지 않다.
    - 둘 다 관련 항목은 고유한 식별자를 참조한다.
    - 문서 참조(document reference) = 외래키
    - 이 식별자는 조인이나 후속 질의를 사용해 읽기 시점에 확인한다. (?)
        - 책 38 페이지 *문서 데이터베이스와의 비교*
- 문서 데이터 모델을 선호하는 주요 이유는 스키마 유연성, 지역성에 기인한 더 나은 성능 때문이고 일부 애플리케이션의 경우 애플리케이션에서 사용하는 데이터 구조와 더 가깝기 떄문이다.

## 그래프형 데이터 모델

- 우리가 생각하는 그래프
- 다대다 관계가 매우 일반적일 때 적합하다.
- 스키마를 강제하지 않는다.
- 그래프에서 데이터를 구조화하고 질의하는 몇가지 다른 방법이 있다.
    - 속성그래프 모델
        - 정점, 간선은 각각의 특징이 있다. (책 참고)
        - 네오포제이(Neo4j), 타이탄(Titan), 인피니티그래프(InfiniteGraph)로 구현
    - 트리플 저장소 모델
        - 모든 정보를 주어, 서술어, 목적어처럼 매우 간단한 세 부분 구문(three-parts statements) 형식으로 저장한다.
        - 데이토믹(Datomic), 알레그로그래프(Allegrograph) 등으로 구현
    - 그래프용 선언형 질의 언어 (책 참고)
        - 사이퍼(Cycher)
        - 스파클(SPARQL)
        - 데이터로그(Datalog)

## 어떤 데이터 모델이 애플리케이션 코드를 더 간단하게 할까?

- 페이지 39(어떤 데이터 모델이 애플리케이션 코드를 더 간단하게 할까?), 페이지 42(문서 데이터베이스와 관계형 데이터베이스의 통합) 참고
- 일반적으로 어떤 데이터 모델이 애플리케이션 코드를 더 간단하게 만드는지 말할 수 없다. 데이터 항목 간에 존재하는 관계 유형에 따라 다르다. 상호 연결이 많은 데이터의 경우 문서 모델은 곤란하지만 관계형 모델은 무난하며 그래프 모델은 매우 자연스럽다.
- 애플리케이션에서 데이터가 문서와 비슷한 구조(일대다 관계 트리로 보통 한 번에 전체 트리를 적재)라면 문서 모델을 사용하는 것이 좋다. 문서와 비슷한 구조를 여러 테이블로 나누어 찢는(sherdding) 관계형 기법은 다루기 힘든 스키마와 불필요하게 복잡한 애플리케이션 코드를 발생시킨다.
- 관계형 데이터베이스와 문서 데이터베이스는 시간이 지남에 따라 점점 더 비슷해지고 있다.
    - 점점 더 많은 관계형 데이터베이스가 JSON 문서에 대해 비슷한 수준의 지원 기능을 제공한다.
    - 문서 데이터베이스 쪽에서 본다면 리싱크DB는 질의 언어에서 관계형 조인을 지원, 몽고DB 드라이버는 자동으로 데이터베이스 참조를 확인한다.

# NoSQL

“NoSQL”이라는 이름은 실제로 어떤 특정 기술을 참고한 것이 아니기에 적절하지 않다. 원래 NoSQL은 2009년에 오픈소스, 분산환경, 비관계형 데이터베이스 밋업(meetup)용 인기 트위터 해시태그였다. 그럼에도 이 용어는 신경을 자극했고 웹스타트업 커뮤니티를 넘어 빠르게 확산됐다. 그래서 NoSQL은 다시 거슬러 올라가 Not Only SQL로 재해석됐다.

NoSQL 데이터베이스 채택한 데는 다음과 같은 다양한 원동력이 있다.

- 대규모데이터셋이나 매우 높은 쓰기 처리량 달성을 관계형 데이터베이스보다 쉽게 할 수 있는 뛰어난 확장성 필요
- 상용 데이터베이스 제품보다 무료 오픈소스 소프트웨어에 대한 선호도 확산
- 관계형 모델에서 지원하지 않는 특수 질의 동작
- 관계형 스키마의 제한에 대한 불만과 더욱 동적이고 표현력이 풍부한 데이터 모델에 대한 바람

NoSQL은 다음과 같은 두가지 주요 갈래가 있다.

1. 문서 데이터베이스는 데이터가 문서 자체에 포함돼 있으면서 하나의 문서와 다른 문서 간 관계가 거의 없는 사용 사례를 대상으로 한다.
2. 그래프 데이터베이스는 문서 데이터베이스와는 정반대로 모든것이 잠재적으로 관련 있다는 사용사례를 대상으로 한다.
