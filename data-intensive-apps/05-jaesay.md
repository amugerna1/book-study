# 5장. 복제

복제란 네트워크로 연결된 여러 장비에 동일한 데이터의 복사본을 유지한다는 의미다.

데이터 복제가 필요한 이유

- 지리적으로 사용자와 가깝게 데이터를 유지해 지연 시간을 줄인다.
- 시스템의 일부에 장애가 발생해도 지속적으로 동작할 수 있게 해 가용성을 높인다.
- 읽기 질의를 제공하는 장비의 수를 확장해 읽기 처리량을 늘린다.

대표적인 복제를 위한 알고리즘

- 단일 리더(single-leader) 복제
- 다중 리더(multi-leader) 복제
- 리더 없는(leaderless) 복제

복제에 고려해야 할 트레이드오프

대개 데이터베이스 설정 옵션이다.

- 동기식 복제와 비동기식 복제 중 어떤 것을 사용할지
- 잘못된 복제본을 어떻게 처리할지

최종 일관성

- 쓰기 읽기(read-your-writes) 보장
- 단조 읽기(monotonic read) 보장

# 리더와 팔로워

## 리더 기반 복제(leader-based replication)

단일 디더 복제를 말하는 것 같다…

모든 복제본에 쓰기를 처리하는 가장 일반적인 방법이다.

복제 서버 중 하는를 리더(leader)로 지정한다. 다른 복제 서버는 팔로워(follower)라고 한다. 

여러 관계형 데이터베이스, 일부 비관계형데이터 베이스, 분산 메시지 브로커에서 사용된다.

쓰기

1. 클라이언트가 데이터베이스에 쓰기를 할 때 요청을 리더에게 보낸다.
2. 리더는 먼저 로컬 저장소에 새로운 데이터를 기록한다.
3. 리더가 로컬저장소에 새로운 데이터를 기록할 때마다 데이터 변경을 복제 로그(replication log)나 변경 스트림(change stream)의 일부로 팔로워에게 전송한다.
4. 각 팔로워가 리더로 부터 로그를 받으면 리더가 처리한 것과 동일한 순서로 모든 쓰기를 적용해 그에 맞게 데이터베이스의 로컬 복사복을 갱신한다.

읽기

클라이언트가 데이터베이스로부터 읽기를 할 때는 리더 또는 임의 팔로워에게 질의할 수 있다. 

## 동기식 대 비동기식 복제

관계형 데이터베이스에서는 보통 설정 가능한 옵션이다.

![그림 5-2](https://user-images.githubusercontent.com/19777164/191979199-2380f7dc-6bfd-463d-a9af-c10765143c81.png)


### 동기식 복제

리더는 팔로워1이 쓰기를 수신했는지 확해줄 떄까지 기다린다. 확인이 끝나면 사용자에게 성공을 보고하고 다른 클라이언트에게 해당 쓰기를 보여준다.

동기식 복제의 장점은 팔로워가 리더와 일관성 있게 최신 데이터 복사본을 가지는 것을 보장한다.

단점은 동기 팔로워가 응답하지 않는다면 쓰기를 차단(block)하고 동기 복제서버가 다시 사용할 수 있을 때까지 기다려야 한다. 임의 한노드의 장애는 전체 시스템을 멈추게 한다.

### 반동기식 복제

모든 팔로워가 동기식이라면 임의 한노드의 장애는 전체 시스템을 멈추기 때문에 모든 팔로워가 동기식인 상황은 비현실적이다. 

팔로워 하나는 동기식으로 하고 그 밖에는 비동기식으로 하여 적어도 두 노드(리더 + 팔로우 1개)에 데이터의 최신복사본이 있는 것을 보장한다.

### 비동기식 복제

리더는 메시지를 전송하지만 팔로워의 응답을 기다리지 않는다.

보통 리더 기반 복제는 완전히 비동기식으로 구성한다.

리더가 잘못되고 복구할 수 없으면 팔로워에 아직 복제되지 않은 모든 쓰기는 유실된다. 하지만 완전 비동기식 설정은 모든 팔로워가 잘못되더라도 리더가 쓰기처리를 계속 할 수 있다.
