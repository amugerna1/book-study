# 7장. 트랜잭션
현실세계의 시스템에서 벌어질 수 있는일.
- 데이터 베이스 소프트웨어나 하드웨어는 언제라도 실패할 수 있다.
- 어플리케이션은 실행도중 언제라도 죽을 수 있다.
- 네트워크가 끊기면 어플리케이션과 데이터베이스의 연결이 갑자기 끊기거나 DB 사이의 통신이 불가할 수 있다.
- 여러 client가 DB에 동시에 쓰기를 실행하여 다른 클라이언트가 쓴 내용을 덮어쓸 수 있다.
- 클라이언트가 부분적으로만 갱신되서 비정상적인 데이터를 읽을 수 있다.
- client의 race condition은 예상하지 못한 버그를 발생시킬 수 있다.

트랜잭션의 개념이 무엇일까?
- 몇개의 읽기와 쓰기를 하나의 논리적 단위로 묶는 방법
- 전체가 성공(commit) 하거나 실패(abort, 롤백)한다.

트랜잭션의 사용 이유
- 오류 부분적인 실패를 걱정할 필요가 없다.
- 동시성 문제의 해결할 수 있다.
- 어떤 경우는 트랜잭션을 완화/사용않는 것이 안전/성능상의 이점이 있다

그렇다면, 트랜잭션이 필요한지에 대한 판단을 할필요가 있다.
이를 위해 트랜잭션이 제공하는 안정성보장의 실체가 무엇인지, 이에 따른 비용은 무엇인지 정확한 이해/판단이 필요하다.

데이터베이스에서 제공하는 알고리즘기준으로 아래와 같은 문제를 논의한다.
- 동시성 문제
- race condition
- 격리 수준의 구현 : read commited, snapshot isolation, serialization

8장에서는 분산에서의 난제를 확인, 7장에서는 단일 분산 시스템에서 확인한다.

## 1. 애매모호한 트랜잭션의 개념
### 새로 등장한 NoSQL vs 전통적인 RDB 사이의 트랜잭션 상이한 접근법
- 전통적인 RDB : "값진 데이터"가 있는 "중대한 애플리케이션"에 필수적인 요구사항이다.
- 새로 등장한 NoSQL : 분산환경에서 높은 성능과 고가용성을 유지하려면 트랜잭션을 포기해야한다.
 두 관점 모두 완전한 과장이다.
 
### ACID의 의미
트랜잭션이 제공하는 안전성 보장은 흔히 원자성(Atomicity), 일관성(Consistency), 격리성(Isolation), 지속성(Durability)로 알려져잇다.
상위 수준의 아이디어는 견실하지만 하지만 이의 구현은 현실 세계에서 데이터베이스마다 제각각이다.

각각의 개념을 살펴보자.

### 원자성이란?
클라이언트가 쓰기 작업 몇개를 실행하려고하는데 그 중일부만 처리된 후 결함이 생기면(예상치못한 종료등) 여러쓰기작업이 하나의 원자적 트랜잭션으로 묶여잇으므로 완료(커밋) 될 수 없다면,
Abort되고 데이터 베이스는 트랜잭션에서 지금까지 실행한 쓰기를 무시하거나 취소해야한다.

원자성의 결국, 원장성의 범위를 정의하고 트랜잭션이 Abort되었다면 어플리케이션에서 어떤 것도 변경되지 않은것으로 판단하여 안전하게 재시도 할 수 잇는 것이다.
( Abortbility)이 원자성보다 나은단어다.

### 일관성이란?
- 5장에서 복제일관성과 비동기식으로 복제되는 시스템에서 발생하는 최종적 일관성문제에 대해 설명했다
- 일관성해싱은 어떤 시스템들에서 재균형화를 위해 사용하는 파티셔닝 방법이다.(204p)
- ACID의 맥락에서 일관성은 DB가 "좋은 상태"에 있어야한다는 것의 애플리케이션에 특화된 개념을 가리킨다.
위와 같이 굉장히 많은 의미가 있다.

불변식,
회계시스템의 모든 계좌에 걸친 대변과 차변은 항상 맞아떨어져야한다.

하지만, 이를 위해서 DB는 보장할 수 있는게 없고, 이는  Application의 책임이다.
일관성은 Application의 책임이며 나머지는 DB의 책임이다.

### 격리성이란?
<img width="698" alt="get counter" src="https://user-images.githubusercontent.com/5934737/195339756-e2a385dc-e38d-4a6a-ad12-6a6763461292.png">
race condition에 놓인 상황에 43이 되었다.

격리성은 트랜잭션은 다른 트랜잭션을 방해 할 수 없는 것을 말한다. 즉, 여러 트랜잭션이 동시에 실행되었더라도 그 결과가 순차적으로 실행되엇을 때와 결과가 동일해야함을 말한다.

### 지속성이란?
트랜잭션이 성공적으로 커밋되었다면 하드웨어 결함이 발생하거나 데이터베이스가 죽더라도 트랜잭션에서 기록한 모든 데이터는 손실되지 않는다라는 보장이다.
지속석을 보장한다는 의미는 commit 전 다른 노드의 복제완료까지를 의미한다.

### 단일 객체 연산과 다중객체 연산
격리성 위반의 예로 : 트랜잭션이 커밋되지 않은 데이터를 읽은 ("Dirty read") 경우이다.
<img width="489" alt="image" src="https://user-images.githubusercontent.com/5934737/195343969-539d7d76-2ba1-44d0-80ae-c3b8fd6651bb.png">
- 않읽은 메시지의 수를 보여주기 위해 별도의 필드로 관리하는 경우(비정규화) 별도의 필드 업데이트도 하나의 트랜잭션에 포함되어야한ㄷ.

원자성이 보장되어야하는 이유는 우편함 삽입동작과 안읽은 메시지 개수동작이 유지가 동기화되어야하는데, 개수갱신을 실패하면 트랜잭션이 어보트되고 삽입된 이메일은 롤백되어야한다.
<img width="493" alt="image" src="https://user-images.githubusercontent.com/5934737/195344618-4f31bfb8-6d6f-4a6f-acf4-a4e92a0f70f4.png">



